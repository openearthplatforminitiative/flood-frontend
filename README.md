# flood-frontend

A demonstration project using the OpenEPI APIs to inform about flood risk.

The project consists of a Next.js-application, a custom Keycloak image used for authentication, as well as AWS and Cloudflare infrastructure defined using [Pulumi](https://www.pulumi.com/).

## Next.js application

Found in the `frontend` folder. Uses Prisma for database access.

### Configuration

When running locally the application expects a `.env.local` file in the root of the `frontend` folder. The file should contain the following variables:

- `KEYCLOAK_ID` - The client ID of the Keycloak client
- `KEYCLOAK_SECRET` - The client secret of the Keycloak client. This secret can be found in the Keycloak admin interface, or in SSM parameter store in the AWS console.
- `KEYCLOAK_ISSUER` - The issuer URL of the Keycloak server. If the realm is called "flood-frontend" and the Keycloak server is using the domain `auth.flood.openepi.io`, the issuer URL would typically be `https://auth.flood.openepi.io/auth/realms/flood-frontend`. During development one should preferably either use a Keycloak server running in a development environment or a local Keycloak server.
- `NEXTAUTH_URL` - The URL of the Next.js application
- `NEXTAUTH_SECRET` - A secret used by NextAuth. During development this can be any string. During production this is automatically generated by Pulumi
- `DATABASE_URL` - The connection string to the database that Prisma should use. Example: `"postgresql://username:password@localhost:5432/flood_frontend"`

### Running the application

To run in development mode for the first time, run `npm install` and then `npm run dev`.

## Keycloak image

Found in the `keycloak` folder. The image is based on the official Keycloak image, but with additional build time configuration and a custom realm. The realm is defined in the `realm.json` file, and it contains several environment variables that are used to configure the realm on launch.

- `FLOOD_FRONTEND_CLIENT_ID` - The client ID of the Keycloak client that flood-frontend will use
- `FLOOD_FRONTEND_CLIENT_SECRET` - The client secret of the Keycloak client that flood-frontend will use
- `FLOOD_FRONTEND_DOMAIN` - The domain that the flood-frontend application is running on. This is used to configure the redirect URI of the Keycloak client.

## Infrastructure

The infrastructure is defined in the `infrastructure` folder using [Pulumi](https://www.pulumi.com/).

### Configuration

The infrastructure expects a `Pulumi.[stack-name].yaml` file in the root of the `infrastructure` folder. The file should contain the following config:

- `aws:region` - The AWS region to deploy to
- `cloudflare:apiToken` - The API token used to authenticate with Cloudflare. The API token can be obtained from the Cloudflare dashboard. The token needs DNS edit access
- `cloudflare:zoneId` - The zone ID of the Cloudflare zone to use
- `flood-frontend:domainName` - The domain name to use for the flood-frontend application.

### Deploying the infrastructure

Use the AWS CLI to authenticate with AWS, and then run `pulumi up` to deploy the infrastructure.
